<!DOCTYPE html>
<html>
	<head>
		<title></title>

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<meta charset="utf-8">

		<link rel="stylesheet" href="js/jquery.mobile-1.2.0.min.css" type="text/css" />
		<link rel="stylesheet" href="css/iphone.css" type="text/css" />
		<link rel="stylesheet" href="css/android.css" type="text/css" />

		<script type="text/javascript" charset="utf-8" src="js/jquery-1.8.2.min.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/base64.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/aes.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/main.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/cordova.js"></script>
		<script src="js/spin.min.js" type="text/javascript"></script>

		<script type="text/javascript">
			$(document).bind("mobileinit", function() {
				// jQuery Mobile フレームワークの設定変更は、ここで行なってください！
				$.support.cors = true;
				$.mobile.allowCrossDomainPages = true;
			});
			$(document).ready(function() {
				document.addEventListener("deviceready", onDeviceReady, false);
			});

			function onDeviceReady() {

				$.ajaxSetup({
					timeout : 5000
				});

				var getText = getLocalStorage('order');
				var get = JSON.parse(getText);

				// 設定ファイルの読み込み
				getonOrdering(getSetting);
			}

			function getSetting(ordering) {
				if (ordering && ordering.customer_pass) {
					// パスワードのチェック
					ckPassTime(ordering);
				} else {
					// ★メイン処理
					setSetting(ordering);
				}
			}

			function ckPassTime(ordering) {
				// ファイルの読み込み
				console.log("Start passtime");
				var fname = 'passtime';
				getFile(fname, onPasstimeOK, onPasstimeNG);
				function onPasstimeOK(json) {
					console.log("正常にテキストを読み込みました。:passtime " + json.pass_time);
					// passtimeの保存
					setLocalStorage('passTime', json.pass_time);
					// ★メイン処理
					setSetting(ordering);
				}
				function onPasstimeNG() {
					setLocalStorage('kbn', 'buy');
					location.href = "passcode_input.html";
				}
			}

			// サーバー通信を行い値を設定を行なう
			function setSetting(params) {

				var title = '初期設定';
				var button = 'OK';

				var url = params.http + 'json/send_setup.php';

				$.ajax({
					type : "POST",
					url : url,
					data : params,
					success : function(data) {
						// 戻り値により処理を振り分ける

						if (data.setup_ok == 1) {
							console.log("-- 注文処理 --");

							// 暗証番号選択式の追加　121211 ogawa
							var inputPass = getLocalStorage('inputPasscode');
							// 暗証番号の入力で購入：true
							var inputedPass = getLocalStorage('inputedPass');
							// passcode_inputで入力している：true

							// passTimeの有無
							if (getLocalStorage('passTime') != null || getLocalStorage('passTime') != "") {

								// 時間経過
								var passTime = getLocalStorage('passTime');
								var cktime = passTime + (60 * 60);
								var nowtime = parseInt(new Date() / 1000);

								// ダイアログメッセージ
								var title = '暗証番号の入力';
								var message = '前回ご購入、または設定操作から時間が経過しています。ご利用者確認のために暗証番号を入力してください';

								var kbn = getLocalStorage('kbn');
								var passInputBtn = getLocalStorage('passInputBtn');
								var purchased_item_flg = getLocalStorage('purchased_item_flg');

								// 暗証番号の入力前
								if (inputedPass == 'false') {

									// 時間経過後（passcode_inputへ）
									if (cktime < nowtime) {

										// 購入の場合
										if (kbn == 'buy' && purchased_item_flg == 'ordered') {
											setLocalStorage('kbn', 'buy');
											setLocalStorage('passInputBtn', 'order');
											// 設定の場合
										} else {
											setLocalStorage('kbn', '');
											setLocalStorage('passInputBtn', 'setting');
										}
										navigator.notification.alert(message, passcodeInput(), title, button);

									// 時間経過前(暗証番号なし)
									} else {

										// 暗証番号必須
										if (inputPass == 'true') {
											// 購入の場合
											if (kbn == 'buy' && purchased_item_flg == 'ordered') {
												title = 'ご購入の確認';
												var message = 'ご登録している暗証番号を入力してください';
												setLocalStorage('kbn', 'buy');
												setLocalStorage('passInputBtn', 'order');
												navigator.notification.alert(message, passcodeInput(), title, button);
												// 設定の場合
											} else {
												setLocalStorage('kbn', '');
												setLocalStorage('passInputBtn', 'setting');
												navigator.notification.alert(message, passcodeInput(), title, button);
											}

										// 暗証番号必須でない
										} else {
											// 購入の場合
											if (kbn == 'buy' && purchased_item_flg == 'ordered') {
												setLocalStorage('kbn', 'buy');
												setLocalStorage('passInputBtn', 'order');
												getOrder(params);
												// 設定の場合
											} else {
												setLocalStorage('kbn', '');
												setLocalStorage('passInputBtn', 'setting');
												window.location.href = "setting.html";
											}
										}
									}
									
								// 暗証番号入力後
								} else {
									// 購入の場合
									if (kbn == 'buy' && purchased_item_flg == 'ordered') {
										setLocalStorage('kbn', 'buy');
										setLocalStorage('passInputBtn', 'order');
										getOrder(params);
										// 設定の場合
									} else {
										setLocalStorage('kbn', '');
										setLocalStorage('passInputBtn', 'setting');
										location.href = "setting.html";
									}
								}
							// passTimeなし
							} else {
								// 暗証番号必須
								if (inputPass == 'true') {
									// 購入の場合
									if (kbn == 'buy' && purchased_item_flg == 'ordered') {
										title = 'ご購入の確認';
										var message = 'ご登録している暗証番号を入力してください';
										setLocalStorage('kbn', 'buy');
										setLocalStorage('passInputBtn', 'order');
										navigator.notification.alert(message, passcodeInput(), title, button);
										// 設定の場合
									} else {
										setLocalStorage('kbn', '');
										setLocalStorage('passInputBtn', 'setting');
										navigator.notification.alert(message, passcodeInput(), title, button);
									}
									// 暗証番号必須でない
								} else {
									// 購入の場合
									if (kbn == 'buy' && purchased_item_flg == 'ordered') {
										setLocalStorage('kbn', 'buy');
										setLocalStorage('passInputBtn', 'order');
										getOrder(params);
										// 設定の場合
									} else {
										setLocalStorage('kbn', '');
										setLocalStorage('passInputBtn', 'setting');
										window.location.href = "setting.html";
									}
								}
							}
							function passcodeInput(){
								window.location.href = "passcode_input.html";
							}

						} else if (data.password_ck == 0) {
							console.log("-- 暗証番号--");
							title = "初期設定";
							var message = '１．暗証番号を設定してください。';
							navigator.notification.alert(message, passcodeAlert(), title, button);
							function passcodeAlert(){
								setLocalStorage('kbn', 'buy');
								window.location.href = "passcode_new.html";
							}
								
						} else if (data.customer_ck == 0) {
							console.log("-- 個人設定・お届け先 --");
							title = "初期設定";
							var message = '２．あなた様のお名前やご住所を設定してください。';
							navigator.notification.alert(message, orderingAlert(), title, button);
							function orderingAlert(){
								setLocalStorage('kbn', 'buy');
								window.location.href = "ordering_new.html";
							}

						} else if (data.address_ck == 0) {
							console.log("-- お届け先 --");
							title = "初期設定";
							var message = '３．お届け先のお名前やご住所を設定してください。';
							navigator.notification.alert(message, addresseeAlert(), title, button);
							function addresseeAlert(){
								setLocalStorage('kbn', 'buy');
								window.location.href = "addressee_new.html";
							}

						} else if (data.card_ck == 0) {
							console.log("-- カード--");
							title = "初期設定";
							var message = '４．お支払いに使うクレジットカード情報を設定してください。クレジットカードはご本人様（個人設定にて設定したお名前・ご住所）のカード以外はご利用いただけません。';
							navigator.notification.alert(message, cardAlert(), title, button);
							function cardAlert(){
								setLocalStorage('kbn', 'buy');
								window.location.href = "card_new.html";
							}

						} else {
							console.log("-- エラー１: 設定がない--");
							title = "初期設定";
							var message = '１．暗証番号を設定してください。';
							navigator.notification.alert(message, etcAlert(), title, button);
							function etcAlert(){
								setLocalStorage('kbn', 'buy');
								window.location.href = "passcode_new.html";
							}
						}
					},
					error : function(data) {
						console.log("-- エラー２--");
						errMsg();
					}
				});
				console.log("-- END--");
			}

			function getOrder(params) {

				// ファイルの読み込み
				console.log("Start order");
				var fname = 'order';
				getFile(fname, onOrderOK, onOrderNG);

				function onOrderOK(order) {
					console.log("正常にorderを読み込みました。");
					order['customer_id'] = params.customer_id;
					order['customer_key'] = params.customer_key;
					order['app_ver'] = params.app_ver;
					order['app_code'] = params.app_code;
					order['url'] = params.url;
					order['http'] = params.http;
					order['https'] = params.https;
					setOrder(order);
				}

				function onOrderNG() {
					location.href = "setting.html";
				}

			}

			// サーバー通信を行い値を設定を行なう
			function setOrder(order) {

				console.log("Start post:" + order);

				var url = order.https + 'json/receive_order.php';

				$.ajax({
					type : "POST",
					url : url,
					data : order,
					success : function(data) {
						// 戻り値により処理を振り分ける
						if (data.errmsg) {
							console.log("-- 注文内容エラー--");
							var msg = {};
							msg['title'] = data.errtitle;
							msg['msg'] = data.errmsg;
							cardErrMsg(msg);
						} else {
							if (data.order_id > 0 && data.order_id < 99999999999) {
								console.log("-- 注文完了--");
								okMsg();
							} else {
								console.log("-- エラー--");
								errMsg();
							}
						}
					},
					error : function(data) {
						console.log("-- 通信エラー--");
						errMsg();
					}
				});

				console.log("-- END--");
			}

			function okMsg() {
				// 注文情報の削除
				delFile('order');
				delFile("backAmount");

				var cancelAttention = getLocalStorage('cancelAttention');
				if (cancelAttention != 'false') {
					// confirmバージョン
					var message = 'ご購入をキャンセルされる場合は、30分以内にお願いいたします。';
					var title = 'ご注文を受付いたしました。';
					var button = "OK,次回表示しない";
					navigator.notification.confirm(message, function(buttonIndex) {
						if (buttonIndex == 1) {
							setLocalStorage('cancelAttention', 'true');
						} else {
							setLocalStorage('cancelAttention', 'false');
						}
						// 購入ボタンのクリックフラグをリセット
						setLocalStorage('purchased_item_flg', '');
						window.location.href = 'show_order.html';
						return false;
					}, title, button);
				}
				window.location.href = 'show_order.html';
				return false;
			}

			function cardErrMsg(msg) {
				// カードエラー
				var button = 'OK';
				navigator.notification.alert(msg.msg, alertCallBack(), msg.title, button);
				location.href = 'setting.html';
			}

			function alertCallBackOk() {
				var fname = 'order';
				var order = {};
				order['qr_id'] = "";
				setFile(fname, order);
			}

			function errMsg() {
				networdERR(alertCallBack, '注文出来ませんでした');
				location.href = 'setting.html';
			}

			function alertCallBack() {
			}

		</script>
		<script type="text/javascript" charset="utf-8" src="js/jquery.mobile-1.2.0.min.js"></script>
	</head>
	<body>
		<div data-role="page" data-add-back-btn="false" data-theme="z">
			<div data-role="header" id="header" data-position="fixed">
				<h1></h1>
			</div>
			<!-- loading -->
			<div class="loading" data-role="content" id="loading">
				<div class="loading_box">
					<p>
						しばらくおまちください
					</p>
					<div id="loadingImg" class="square"></div>
					<script>
						// spin setting
						var opts = {
							lines : 15, // The number of lines to draw
							length : 28, // The length of each line
							width : 5, // The line thickness
							radius : 14, // The radius of the inner circle
							corners : 1, // Corner roundness (0..1)
							rotate : 0, // The rotation offset
							color : '#fff', // #rgb or #rrggbb
							speed : 1, // Rounds per second
							trail : 60, // Afterglow percentage
							shadow : false, // Whether to render a shadow
							hwaccel : false, // Whether to use hardware acceleration
							className : 'spinner', // The CSS class to assign to the spinner
							zIndex : 2e9//, // The z-index (defaults to 2000000000)
							//	top : 'auto', // Top position relative to parent in px
							//	left : 'auto' // Left position relative to parent in px
						};
						var target = document.getElementById('loadingImg');
						var spinner = new Spinner(opts).spin(target);
					</script>
				</div>
			</div>
		</div>
	</body>
</html>